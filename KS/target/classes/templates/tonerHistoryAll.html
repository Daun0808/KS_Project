<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í† ë„ˆ ì…ì¶œê³  ëª©ë¡</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <style>
        .navbar-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: #f8f9fa;
            padding: 5px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .navbar-btn {
            font-size: 1rem;
            margin-right: 15px;
        }
        body {
            padding-top: 60px;
        }
    </style>

    <script>
        // í…Œì´ë¸” í•„í„° í•¨ìˆ˜
        function showSummary() {
            let departmentInput = document
                .getElementById("departmentSearch")
                .value.toLowerCase();

            let startDateStr = document.getElementById("startDate").value;
            let endDateStr = document.getElementById("endDate").value;

            let rows = document.querySelectorAll("tbody tr");

            let startDate = startDateStr ? new Date(startDateStr) : null;
            let endDate = endDateStr ? new Date(endDateStr) : null;

            let summaryMap = {};

            rows.forEach((row) => {

                // ì´ë¯¸ summary-rowë©´ ìŠ¤í‚µ
                if (row.classList.contains("summary-row")) return;

                const dateText = row.children[0].innerText;
                const department = row.children[1].innerText;
                const tonerName = row.children[2].innerText;
                const delivery = parseInt(row.children[3].innerText) || 0;

                let rowDate = new Date(dateText);

                const matchDepartment = department
                    .toLowerCase()
                    .includes(departmentInput);

                let matchDate = true;
                if (startDate && rowDate < startDate) matchDate = false;
                if (endDate && rowDate > endDate) matchDate = false;

                const isMatch = matchDepartment && matchDate;

                // ğŸ”¥ ì›ë³¸ í–‰ ì „ë¶€ ìˆ¨ê¹€
                row.style.display = "none";

                if (isMatch) {
                    const key = department + "||" + tonerName;

                    if (!summaryMap[key]) {
                        summaryMap[key] = 0;
                    }

                    summaryMap[key] += delivery;
                }
            });

            // ê¸°ì¡´ í•©ê³„í–‰ ì œê±°
            document.querySelectorAll(".summary-row").forEach(row => row.remove());

            const tbody = document.querySelector("tbody");

            // ğŸ”¥ í•©ê³„í–‰ ìƒì„±
            for (let key in summaryMap) {
                const [department, tonerName] = key.split("||");
                const total = summaryMap[key];

                let tr = document.createElement("tr");
                tr.classList.add("summary-row");
                tr.style.backgroundColor = "#d9edf7";

                tr.innerHTML = `
            <td></td>
            <td><strong>${department}</strong></td>
            <td><strong>${tonerName}</strong></td>
            <td><strong>${total}</strong></td>
        `;

                tbody.appendChild(tr);
            }
        }


        function resetTable() {
            // ğŸ”¥ í•©ê³„í–‰ ì œê±°
            document.querySelectorAll(".summary-row").forEach(row => row.remove());

            // ğŸ”¥ ì›ë³¸ í–‰ ë‹¤ì‹œ ë³´ì´ê¸°
            document.querySelectorAll("tbody tr")


            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê¸°ë³¸ê°’ ì„¸íŒ… (ì˜¤ëŠ˜, í•œ ë‹¬ ì „)
            window.onload = function () {
                const startDateInput = document.getElementById("startDate");
                const endDateInput = document.getElementById("endDate");

                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, "0");
                const dd = String(today.getDate()).padStart(2, "0");

                const endDateStr = `${yyyy}-${mm}-${dd}`;
                endDateInput.value = endDateStr;

                const oneMonthAgo = new Date(today);
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

                const yyyyStart = oneMonthAgo.getFullYear();
                const mmStart = String(oneMonthAgo.getMonth() + 1).padStart(2, "0");
                const ddStart = String(oneMonthAgo.getDate()).padStart(2, "0");

                const startDateStr = `${yyyyStart}-${mmStart}-${ddStart}`;
                startDateInput.value = startDateStr;

                filterTable(); // ì´ˆê¸° í•„í„° ì ìš©
            }
        };
    </script>
</head>
<body>
<div class="navbar-fixed">
    <div class="container d-flex justify-content-start">
        <a href="/" class="btn btn-outline-primary navbar-btn">í™ˆ</a>
        <a href="/department" class="btn btn-outline-success navbar-btn">ë¶€ì„œ ê´€ë¦¬</a>
        <a href="/printer" class="btn btn-outline-danger navbar-btn">í”„ë¦°í„° ê´€ë¦¬</a>
        <a href="/toner" class="btn btn-outline-warning navbar-btn">í† ë„ˆ ê´€ë¦¬</a>
        <a href="/toner/month" class="btn btn-outline-warning navbar-btn">ì›”ë³„ í† ë„ˆ ì¬ê³ </a>
        <a href="/computer" class="btn btn-outline-info navbar-btn">ì»´í“¨í„° ê´€ë¦¬</a>
        <a href="/monitor" class="btn btn-outline-secondary navbar-btn">ëª¨ë‹ˆí„° ê´€ë¦¬</a>
    </div>
</div>

<div class="container mt-5">
    <h2 class="text-center mb-4">í† ë„ˆ ì…ì¶œê³  ëª©ë¡</h2>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label for="startDate" class="form-label">ì‹œì‘ì¼</label>
            <input
                    type="date"
                    id="startDate"
                    class="form-control"
                    onchange="filterTable()"
            />
        </div>
        <div class="col-md-3">
            <label for="endDate" class="form-label">ì¢…ë£Œì¼</label>
            <input
                    type="date"
                    id="endDate"
                    class="form-control"
                    onchange="filterTable()"
            />
        </div>
        <div class="col-md-3">
            <label for="departmentSearch" class="form-label">ë¶€ì„œëª…</label>
            <input
                    type="text"
                    id="departmentSearch"
                    class="form-control"
                    placeholder="ë¶€ì„œëª… ê²€ìƒ‰"
                    onkeyup="filterTable()"
            />
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" onclick="showSummary()">ê²€ìƒ‰</button>
            <button class="btn btn-secondary" onclick="resetTable()">ì´ˆê¸°í™”</button>
        </div>

    </div>

    <table class="table table-striped">
        <thead>
        <tr>
            <th>ë‚ ì§œ</th>
            <th>ë¶€ì„œëª…</th>
            <th>í† ë„ˆ ì´ë¦„</th>
            <th>ì¶œê³  ìˆ˜ëŸ‰</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="history : ${tonerHistoryList}">
            <td th:text="${history.historyDate()}"></td>
            <td th:text="${history.departmentName()}"></td>
            <td th:text="${history.tonerName()}"></td>
            <td th:text="${history.historyDelivery()}"></td>
        </tr>
        </tbody>
    </table>

    <div class="mt-3 text-center">
        <a href="/toner/month" class="btn btn-secondary">í† ë„ˆ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
